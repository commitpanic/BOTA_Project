{% extends 'base.html' %}
{% load i18n %}
{% load static %}

{% block title %}{% trans "Bunkers Map" %} - BOTA Project{% endblock %}

{% block extra_css %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    #map {
        height: calc(100vh - 200px);
        min-height: 500px;
        width: 100%;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .map-legend {
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
    }
    
    .legend-icon {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 10px;
        color: white;
        font-size: 14px;
    }
    
    .legend-icon.gold {
        background-color: #FFD700;
        color: #000;
    }
    
    .legend-icon.green {
        background-color: #28a745;
    }
    
    .legend-icon.blue {
        background-color: #007bff;
    }
    
    .legend-icon.gray {
        background-color: #6c757d;
    }
    
    .legend-icon.red {
        background-color: #dc3545;
    }
    
    .legend-icon.orange {
        background-color: #fd7e14;
    }
    
    .map-stats {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        color: white;
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 20px;
    }
    
    .leaflet-popup-content {
        min-width: 200px;
    }
    
    .popup-title {
        font-weight: bold;
        font-size: 16px;
        margin-bottom: 8px;
        color: var(--primary-color);
    }
    
    .popup-reference {
        background-color: var(--primary-color);
        color: white;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 12px;
        display: inline-block;
        margin-bottom: 8px;
    }
    
    .popup-status {
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #eee;
    }
    
    .status-badge {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 11px;
        margin-right: 5px;
        margin-bottom: 5px;
    }
    
    .status-badge.activated {
        background-color: #28a745;
        color: white;
    }
    
    .status-badge.hunted {
        background-color: #007bff;
        color: white;
    }
    
    .map-controls {
        margin-bottom: 15px;
    }
    
    .filter-btn {
        margin-right: 5px;
        margin-bottom: 5px;
    }
    
    /* Pulsating animation for active spots */
    @keyframes pulse {
        0% {
            box-shadow: 0 0 0 0 rgba(253, 126, 20, 0.7);
        }
        50% {
            box-shadow: 0 0 0 10px rgba(253, 126, 20, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(253, 126, 20, 0);
        }
    }
    
    .marker-under-activation {
        animation: pulse 2s infinite;
        border: 3px solid #fd7e14 !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col-12">
        <h1><i class="bi bi-map"></i> {% trans "Bunkers Map" %}</h1>
        <p class="text-muted">
            {% trans "Interactive map showing all BOTA bunkers locations" %}
        </p>
    </div>
</div>

<!-- Statistics -->
<div class="row mb-3">
    <div class="col-md-12">
        <div class="map-stats">
            <div class="row text-center">
                <div class="col-md-4">
                    <h3 id="total-count">-</h3>
                    <small>{% trans "Total Bunkers" %}</small>
                </div>
                {% if user.is_authenticated %}
                <div class="col-md-2">
                    <h3 id="activated-count">-</h3>
                    <small>{% trans "Activated by You" %}</small>
                </div>
                <div class="col-md-2">
                    <h3 id="hunted-count">-</h3>
                    <small>{% trans "Hunted by You" %}</small>
                </div>
                <div class="col-md-2">
                    <h3 id="remaining-count">-</h3>
                    <small>{% trans "Not Yet Worked" %}</small>
                </div>
                <div class="col-md-2">
                    <h3 id="under-activation-count">-</h3>
                    <small>{% trans "Under Activation" %}</small>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% if user.is_authenticated %}
<!-- Legend and Filters -->
<div class="row mb-3">
    <div class="col-md-6">
        <div class="map-legend">
            <h5 class="mb-3"><i class="bi bi-info-circle"></i> {% trans "Legend" %}</h5>
            <div class="legend-item">
                <div class="legend-icon gold">
                    <i class="bi bi-trophy"></i>
                </div>
                <span><strong>{% trans "Gold" %}</strong> - {% trans "Activated AND Hunted" %}</span>
            </div>
            <div class="legend-item">
                <div class="legend-icon green">
                    <i class="bi bi-broadcast"></i>
                </div>
                <span><strong>{% trans "Green" %}</strong> - {% trans "Activated (not hunted)" %}</span>
            </div>
            <div class="legend-item">
                <div class="legend-icon blue">
                    <i class="bi bi-binoculars"></i>
                </div>
                <span><strong>{% trans "Blue" %}</strong> - {% trans "Hunted (not activated)" %}</span>
            </div>
            <div class="legend-item">
                <div class="legend-icon gray">
                    <i class="bi bi-geo-alt"></i>
                </div>
                <span><strong>{% trans "Gray" %}</strong> - {% trans "Not yet worked" %}</span>
            </div>
            <hr>
            <div class="legend-item">
                <div class="legend-icon gold marker-under-activation">
                    <i class="bi bi-broadcast-pin"></i>
                </div>
                <span><strong>ðŸŸ  {% trans "Orange border" %}</strong> - {% trans "Under Activation" %} ({% trans "active spot" %})</span>
            </div>
            <small class="text-muted">{% trans "Pulsating orange border indicates someone is currently activating this bunker" %}</small>
        </div>
    </div>
    <div class="col-md-6">
        <div class="map-legend">
            <h5 class="mb-3"><i class="bi bi-funnel"></i> {% trans "Filters" %} <small class="text-muted">({% trans "select multiple" %})</small></h5>
            <div class="map-controls">
                <div class="form-check form-check-inline">
                    <input class="form-check-input filter-checkbox" type="checkbox" id="filter-gold" value="gold">
                    <label class="form-check-label" for="filter-gold">
                        <i class="bi bi-trophy text-warning"></i> {% trans "Gold" %}
                    </label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input filter-checkbox" type="checkbox" id="filter-green" value="green">
                    <label class="form-check-label" for="filter-green">
                        <i class="bi bi-broadcast text-success"></i> {% trans "Activated" %}
                    </label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input filter-checkbox" type="checkbox" id="filter-blue" value="blue">
                    <label class="form-check-label" for="filter-blue">
                        <i class="bi bi-binoculars text-primary"></i> {% trans "Hunted" %}
                    </label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input filter-checkbox" type="checkbox" id="filter-gray" value="gray">
                    <label class="form-check-label" for="filter-gray">
                        <i class="bi bi-geo-alt text-secondary"></i> {% trans "Not Worked" %}
                    </label>
                </div>
                <br>
                <div class="form-check form-check-inline mt-2">
                    <input class="form-check-input" type="checkbox" id="filter-under-activation">
                    <label class="form-check-label" for="filter-under-activation">
                        <span style="display: inline-block; width: 20px; height: 20px; border-radius: 50%; background: #fd7e14; animation: pulse 2s infinite; vertical-align: middle;"></span>
                        <i class="bi bi-broadcast-pin" style="color: #fd7e14;"></i> {% trans "Under Activation" %}
                    </label>
                </div>
                <br>
                <button class="btn btn-sm btn-secondary mt-2" id="reset-filter">
                    <i class="bi bi-x-circle"></i> {% trans "Show All" %}
                </button>
            </div>
        </div>
    </div>
</div>
{% else %}
<!-- Legend for anonymous users -->
<div class="row mb-3">
    <div class="col-md-12">
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> 
            {% trans "Log in to see which bunkers you have activated or hunted!" %}
            <a href="{% url 'login' %}" class="alert-link">{% trans "Login" %}</a> | 
            <a href="{% url 'register' %}" class="alert-link">{% trans "Register" %}</a>
        </div>
    </div>
</div>
{% endif %}

<!-- Location Search -->
<div class="row mb-3">
    <div class="col-md-8 col-lg-6">
        <div class="input-group">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input type="text" class="form-control" id="locationSearch" placeholder="{% trans 'Search by reference, name or location' %}">
            <button class="btn btn-primary" type="button" id="searchButton">
                {% trans "Search" %}
            </button>
        </div>
        <small class="text-muted">
            {% trans "Examples: Pz.W. 716, WisÅ‚a, B/SP-0001, Warsaw, 52.2297,21.0122" %}
        </small>
    </div>
</div>

<!-- Map -->
<div class="row">
    <div class="col-12">
        <div id="map"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    // Bunkers data from Django
    const bunkersData = {{ bunkers_json|safe }};
    const isAuthenticated = {% if user.is_authenticated %}true{% else %}false{% endif %};
    
    // Initialize map centered on Poland
    const map = L.map('map').setView([52.0, 19.0], 7);
    
    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        maxZoom: 19,
    }).addTo(map);
    
    // Store markers for filtering
    const markers = [];
    let activeFilters = new Set();
    
    // Color mapping
    const colorMap = {
        'gold': '#FFD700',
        'green': '#28a745',
        'blue': '#007bff',
        'gray': '#6c757d',
        'red': '#dc3545',
        'orange': '#fd7e14'
    };
    
    // Create custom marker icons
    function createMarkerIcon(color, iconName, isUnderActivation = false) {
        const iconColor = color === 'gold' ? '#000' : '#fff';
        const pulseClass = isUnderActivation ? 'marker-under-activation' : '';
        return L.divIcon({
            className: 'custom-marker',
            html: `<div class="${pulseClass}" style="background-color: ${colorMap[color]}; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">
                    <i class="bi bi-${iconName}" style="color: ${iconColor}; font-size: 14px;"></i>
                   </div>`,
            iconSize: [30, 30],
            iconAnchor: [15, 15],
            popupAnchor: [0, -15]
        });
    }
    
    // Add markers for each bunker
    bunkersData.forEach(bunker => {
        const icon = createMarkerIcon(bunker.color, bunker.icon, bunker.is_under_activation);
        const marker = L.marker([bunker.lat, bunker.lng], { icon: icon });
        
        // Create popup content
        let popupContent = `
            <div class="popup-title">${bunker.name}</div>
            <span class="popup-reference">${bunker.reference}</span>
        `;
        
        if (isAuthenticated) {
            popupContent += '<div class="popup-status">';
            if (bunker.is_under_activation) {
                popupContent += '<span class="status-badge" style="background-color: #fd7e14; color: white;"><i class="bi bi-broadcast-pin"></i> {% trans "Under Activation" %}</span>';
            }
            if (bunker.is_activated) {
                popupContent += '<span class="status-badge activated"><i class="bi bi-broadcast"></i> {% trans "Activated" %}</span>';
            }
            if (bunker.is_hunted) {
                popupContent += '<span class="status-badge hunted"><i class="bi bi-binoculars"></i> {% trans "Hunted" %}</span>';
            }
            if (!bunker.is_activated && !bunker.is_hunted && !bunker.is_under_activation) {
                popupContent += '<span class="text-muted"><i class="bi bi-dash-circle"></i> {% trans "Not yet worked" %}</span>';
            }
            popupContent += '</div>';
        } else if (bunker.is_under_activation) {
            popupContent += '<div class="popup-status">';
            popupContent += '<span class="status-badge" style="background-color: #fd7e14; color: white;"><i class="bi bi-broadcast-pin"></i> {% trans "Under Activation" %}</span>';
            popupContent += '</div>';
        }
        
        popupContent += `<div class="mt-2">
            <a href="/bunkers/${bunker.reference}/" class="btn btn-sm btn-primary text-white text-decoration-none">
                <i class="bi bi-info-circle"></i> {% trans "Details" %}
            </a>
        </div>`;
        
        marker.bindPopup(popupContent);
        marker.addTo(map);
        
        // Store marker with data for filtering
        markers.push({
            marker: marker,
            color: bunker.color,
            data: bunker
        });
    });
    
    // Calculate statistics
    if (isAuthenticated) {
        const activatedCount = bunkersData.filter(b => b.is_activated).length;
        const huntedCount = bunkersData.filter(b => b.is_hunted).length;
        const notWorkedCount = bunkersData.filter(b => !b.is_activated && !b.is_hunted).length;
        const totalBunkers = bunkersData.length;
        const under_activation = bunkersData.filter(b => b.is_under_activation).length;
        
        document.getElementById('activated-count').textContent = activatedCount;
        document.getElementById('hunted-count').textContent = huntedCount;
        document.getElementById('remaining-count').textContent = notWorkedCount;
        document.getElementById('total-count').textContent = notWorkedCount + huntedCount;
        document.getElementById('under-activation-count').textContent = under_activation;
    }
    
    // Fit map to show all markers
    if (markers.length > 0) {
        const group = L.featureGroup(markers.map(m => m.marker));
        map.fitBounds(group.getBounds().pad(0.1));
    }
    
    // Filter functionality - checkboxes allow multiple selections
    let showOnlyUnderActivation = false;
    
    document.querySelectorAll('.filter-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const filter = this.value;
            
            if (this.checked) {
                activeFilters.add(filter);
            } else {
                activeFilters.delete(filter);
            }
            
            applyFilter();
        });
    });
    
    // Special filter for "Under Activation"
    document.getElementById('filter-under-activation')?.addEventListener('change', function() {
        showOnlyUnderActivation = this.checked;
        applyFilter();
    });
    
    document.getElementById('reset-filter')?.addEventListener('click', function() {
        activeFilters.clear();
        showOnlyUnderActivation = false;
        document.querySelectorAll('.filter-checkbox').forEach(cb => cb.checked = false);
        document.getElementById('filter-under-activation').checked = false;
        applyFilter();
    });
    
    function applyFilter() {
        markers.forEach(item => {
            let showByColor = activeFilters.size === 0 || activeFilters.has(item.color);
            let showByActivation = !showOnlyUnderActivation || item.data.is_under_activation;
            
            // Show marker if it passes both filters (OR logic for colors, AND logic with under_activation)
            if (showByColor && showByActivation) {
                map.addLayer(item.marker);
            } else {
                map.removeLayer(item.marker);
            }
        });
        
        // Update visible count
        const visibleCount = markers.filter(item => {
            let showByColor = activeFilters.size === 0 || activeFilters.has(item.color);
            let showByActivation = !showOnlyUnderActivation || item.data.is_under_activation;
            return showByColor && showByActivation;
        }).length;
        
        document.getElementById('total-bunkers').textContent = visibleCount;
    }
    
    // Location search functionality
    let searchMarker = null;
    
    document.getElementById('searchButton').addEventListener('click', performSearch);
    document.getElementById('locationSearch').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            performSearch();
        }
    });
    
    async function performSearch() {
        const query = document.getElementById('locationSearch').value.trim();
        
        if (!query) {
            return;
        }
        
        const searchTerm = query.toLowerCase();
        
        // First, try to find bunker by reference number
        let matchedBunker = bunkersData.find(bunker => {
            const ref = bunker.reference.toLowerCase();
            
            // Exact match
            if (ref === searchTerm) return true;
            
            // Partial match (e.g., "A8" matches "A Pz.W. 8")
            if (ref.includes(searchTerm)) return true;
            
            // Match without spaces/dots (e.g., "A8" matches "A Pz.W. 8")
            const refNormalized = ref.replace(/[\s\.\-\/]/g, '');
            const searchNormalized = searchTerm.replace(/[\s\.\-\/]/g, '');
            if (refNormalized.includes(searchNormalized)) return true;
            
            return false;
        });
        
        // If not found by reference, try to find by bunker name
        if (!matchedBunker) {
            matchedBunker = bunkersData.find(bunker => {
                if (!bunker.name) return false;
                
                const name = bunker.name.toLowerCase();
                
                // Check if search term is in the bunker name
                if (name.includes(searchTerm)) return true;
                
                // Also check normalized version (without special characters)
                const nameNormalized = name.replace(/[\s\.\-\/]/g, '');
                const searchNormalized = searchTerm.replace(/[\s\.\-\/]/g, '');
                if (nameNormalized.includes(searchNormalized)) return true;
                
                return false;
            });
        }
        
        if (matchedBunker) {
            // Found bunker by reference or name - zoom to it and open popup
            const markerItem = markers.find(m => m.data.reference === matchedBunker.reference);
            if (markerItem) {
                map.setView([matchedBunker.lat, matchedBunker.lng], 15);
                markerItem.marker.openPopup();
                
                // Remove previous search marker if any
                if (searchMarker) {
                    map.removeLayer(searchMarker);
                    searchMarker = null;
                }
                return;
            }
        }
        
        // Check if input is coordinates (lat,lon format)
        const coordMatch = query.match(/^(-?\d+\.?\d*)\s*,\s*(-?\d+\.?\d*)$/);
        if (coordMatch) {
            const lat = parseFloat(coordMatch[1]);
            const lon = parseFloat(coordMatch[2]);
            
            if (lat >= -90 && lat <= 90 && lon >= -180 && lon <= 180) {
                showSearchResult(lat, lon, query);
                return;
            }
        }
        
        // Use Nominatim geocoding API (OpenStreetMap)
        try {
            const response = await fetch(
                `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=pl&limit=1`,
                {
                    headers: {
                        'User-Agent': 'BOTA-Project/1.0'
                    }
                }
            );
            
            const data = await response.json();
            
            if (data && data.length > 0) {
                const result = data[0];
                const lat = parseFloat(result.lat);
                const lon = parseFloat(result.lon);
                showSearchResult(lat, lon, result.display_name);
            } else {
                alert('{% trans "Location or bunker not found. Try another search term." %}');
            }
        } catch (error) {
            console.error('Geocoding error:', error);
            alert('{% trans "Search error. Please try again." %}');
        }
    }
    
    function showSearchResult(lat, lon, displayName) {
        // Remove previous search marker
        if (searchMarker) {
            map.removeLayer(searchMarker);
        }
        
        // Create red pin marker for search result
        const searchIcon = L.divIcon({
            html: `<div style="background-color: #dc3545; width: 30px; height: 30px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center;">
                    <i class="bi bi-geo-alt-fill" style="color: white; font-size: 18px;"></i>
                   </div>`,
            className: 'search-marker',
            iconSize: [30, 30],
            iconAnchor: [15, 15]
        });
        
        searchMarker = L.marker([lat, lon], { icon: searchIcon })
            .addTo(map)
            .bindPopup(`<strong>{% trans "Search Result" %}</strong><br>${displayName}`)
            .openPopup();
        
        // Pan and zoom to location
        map.setView([lat, lon], 13);
    }
</script>
{% endblock %}
